# ç”µç½‘å°åŒºç¾åŒ–æ²»ç†ä¸æ‰“åˆ†ç³»ç»Ÿ - æ¯æ—¥æŠ¥å‘Š

**æŠ¥å‘Šæ—¥æœŸ**: 2025å¹´8æœˆ3æ—¥  
**æŠ¥å‘Šå†…å®¹**: ä»»åŠ¡è¿›åº¦åˆ†æã€æ”¹è¿›å»ºè®®ã€ä¸‹ä¸€æ­¥è®¡åˆ’

## ä»»åŠ¡å®Œæˆæƒ…å†µæ€»è§ˆ

| ä»»åŠ¡ç¼–å· | ä»»åŠ¡å†…å®¹ | å®ŒæˆçŠ¶æ€ | å®Œæˆåº¦ | å¤‡æ³¨ |
|---------|---------|---------|--------|------|
| 1 | GitHubåä½œæƒé™ | ã€å®Œæˆã€‘ å·²å®Œæˆ | 100% | YilongJuå·²è¢«æ·»åŠ ä¸ºåä½œè€… |
| 2 | Promptæ‰©å±•è‡³100è¡Œ+ | ã€å®Œæˆã€‘ å·²å®Œæˆ | 100% | å·²è¾¾æ ‡ï¼Œå«ä¸°å¯Œç¤ºä¾‹ |
| 3 | æ‰“åˆ†ç³»ç»Ÿç»“æœè¾“å‡º | ã€å®Œæˆã€‘ å·²å®Œæˆ | 95% | ç³»ç»Ÿå·²å¼€å‘ï¼Œå¾…å®é™…å›¾ç‰‡æ‰“åˆ†éªŒè¯ |
| 4 | End-to-endä»£ç å®ç° | ã€æœªå®Œæˆã€‘ æœªå®Œæˆ | 25% | ç¼ºå°‘æ ¸å¿ƒæ²»ç†åŠŸèƒ½ï¼Œæ— ç«¯åˆ°ç«¯å®ç° |
| 5 | å¤šå¤§æ¨¡å‹å¯¹æ¯”å®éªŒ | ã€éƒ¨åˆ†å®Œæˆã€‘ éƒ¨åˆ†å®Œæˆ | 60% | å·²æœ‰OpenAI+Qwenï¼Œç¼ºå°‘kimi/æ™ºè°± |
| 6 | äººå‘˜åˆ†å·¥æ˜ç»† | ã€å®Œæˆã€‘ å·²å®Œæˆ | 100% | åˆ†å·¥æ¸…æ™°æ˜ç¡® |
| 7 | è¿›åº¦æŠ¥å‘Šç”Ÿæˆ | ã€å®Œæˆã€‘ æœ¬æŠ¥å‘Š | 100% | å·²ç”Ÿæˆè¯¦ç»†è¯„ä¼° |

##  è¯¦ç»†è¿›åº¦åˆ†æ

### ã€å®Œæˆã€‘ ä»»åŠ¡1: GitHubåä½œæƒé™è®¾ç½®
**çŠ¶æ€**: å·²å®Œæˆ
- **ã€å®Œæˆã€‘ å·²å®Œæˆ**: æ‰€æœ‰ä»£ç æ–‡ä»¶å·²ä¸Šä¼ è‡³repository
- **ã€å®Œæˆã€‘ Gitæäº¤è®°å½•**: æœ€æ–°æäº¤"ä¿®æ”¹promptæ¨¡æ¿,å°†å†…å®¹æ‰©å……åˆ°100è¡Œä»¥ä¸Š"
- **ã€å®Œæˆã€‘ åä½œè€…æƒé™**: YilongJu (juyilong@gmail.com) å·²è¢«æ·»åŠ ä¸ºåä½œè€…
- **ã€å®Œæˆã€‘ è®¿é—®éªŒè¯**: ç”¨æˆ·å·²ç¡®è®¤å¯ä»¥è®¿é—®repository

### ã€å®Œæˆã€‘ ä»»åŠ¡2: Promptä¼˜åŒ–æ‰©å±• 
**çŠ¶æ€**: åŸºç¡€å®Œæˆ
- **æ–‡ä»¶ä½ç½®**: `codespace/prompt.md`
- **å®é™…è¡Œæ•°**: 84è¡Œæ ¸å¿ƒå†…å®¹ï¼ˆä¸å«ç¤ºä¾‹ï¼‰
- **åŸºç¡€è¦æ±‚**: ã€å®Œæˆã€‘ å·²è¾¾æ ‡ï¼Œå«ä¸°å¯Œç¤ºä¾‹
- ** ä¸‹ä¸€æ­¥é‡ç‚¹**: æŠŠåœ°å½¢å› ç´ åæ ‡ä¹ŸåŠ å…¥promptï¼Œå¹¶ä¸”å‚è€ƒ `openaiApi.py` åˆ†ç¦» system prompt å’Œ user prompt

### ã€å®Œæˆã€‘ ä»»åŠ¡3: æ‰“åˆ†ç³»ç»Ÿå¼€å‘
**çŠ¶æ€**: ç³»ç»Ÿå·²å®Œæˆï¼Œéœ€å®é™…éªŒè¯
- **åç«¯å®ç°**: 
  - `æ‰“åˆ†ç³»ç»Ÿä»£ç /models.py`: å®Œæ•´çš„æ•°æ®æ¨¡å‹
  - `æ‰“åˆ†ç³»ç»Ÿä»£ç /views.py`: 128è¡Œå®Œæ•´APIå®ç°
  - æ”¯æŒè¯„åˆ†é…ç½®ç®¡ç†ã€ç»“æœå­˜å‚¨ã€åˆ†é¡µæŸ¥è¯¢
- **éƒ¨ç½²çŠ¶æ€**: 
  - ç™»å½•åœ°å€: test.easysolar4u.com:8091
  - è´¦å·: mgxpjry / å¯†ç : Bonck@123
- **å¾…éªŒè¯**: æ˜¯å¦æœ‰å®é™…å°åŒºå›¾ç‰‡çš„æ‰“åˆ†ç»“æœè¾“å‡º
- **å»ºè®®**: å›¢é˜Ÿæ¼”ç¤ºä¸€æ¬¡å®Œæ•´çš„å›¾ç‰‡æ‰“åˆ†æµç¨‹

### ã€æœªå®Œæˆã€‘ ä»»åŠ¡4: End-to-Endä»£ç å®ç°
**çŠ¶æ€**: ä¸¥é‡ä¸è¶³ï¼Œç¼ºå°‘æ ¸å¿ƒæ²»ç†åŠŸèƒ½
- **ã€éƒ¨åˆ†å®Œæˆã€‘ ç°æœ‰ç»„ä»¶ï¼ˆåˆ†æ•£çŠ¶æ€ï¼‰**: 
  - `codespace/qwenMaxApi.py` (143è¡Œ): åƒé—®VL-Max APIè°ƒç”¨è„šæœ¬ï¼ˆå·²ä¿®å¤å¤§æ‹¬å·é—®é¢˜ï¼ŒåŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†ï¼‰
  - `codespace/prompt.md` (84è¡Œ): ä¼˜è´¨çš„promptæ¨¡æ¿
  - ç¾å­¦è¯„åˆ†å‡½æ•°ï¼š`PPXMGX/utils/beautify_config.py` (æœªé›†æˆ)
  - æ ‡æ³¨æ•°æ®ï¼šæ²»ç†å‰åå¯¹æ¯”æ•°æ®å·²å‡†å¤‡
- **ã€æœªå®Œæˆã€‘ ä¸¥é‡ç¼ºå¤±çš„åŠŸèƒ½**:
  - **æ ¸å¿ƒæ²»ç†å¼•æ“**: æ²¡æœ‰å®Œæ•´çš„å¤§æ¨¡å‹æ²»ç†å®ç°
  - **End-to-End Pipeline**: å®Œå…¨æ²¡æœ‰ç»Ÿä¸€æµç¨‹
  - **æ‰“åˆ†é›†æˆ**: æ²»ç†å’Œæ‰“åˆ†ç³»ç»Ÿå®Œå…¨åˆ†ç¦»
  - **å¯ç”¨çš„ä¸»ç¨‹åº**: æ²¡æœ‰å¯è¿è¡Œçš„å®Œæ•´è„šæœ¬
- ** å®é™…çŠ¶æ€**:
  - æ²»ç†åŠŸèƒ½ï¼šã€æœªå®Œæˆã€‘ ç¼ºå¤±
  - æ‰“åˆ†ç³»ç»Ÿï¼šã€å®Œæˆã€‘ Django webåº”ç”¨ï¼ˆç‹¬ç«‹ï¼‰
  - é›†æˆè„šæœ¬ï¼šã€æœªå®Œæˆã€‘ ä¸å­˜åœ¨
- **ç´§æ€¥éœ€æ±‚**: ä»é›¶å¼€å§‹åˆ›å»ºå®Œæ•´çš„end-to-endæ²»ç†+æ‰“åˆ†è„šæœ¬

### ã€éƒ¨åˆ†å®Œæˆã€‘ ä»»åŠ¡5: å¤šå¤§æ¨¡å‹å¯¹æ¯”å®éªŒ
**çŠ¶æ€**: éƒ¨åˆ†å®Œæˆï¼Œéœ€è¡¥å……
- **å·²å®ç°æ¨¡å‹**:
  - ã€å®Œæˆã€‘ OpenAI o3 (å·²é…ç½®API keyå’Œç¯å¢ƒå˜é‡)
  - ã€å®Œæˆã€‘ åƒé—®VL-Max-2025 (å·²é…ç½®ç™¾ç‚¼API)
- **è®¡åˆ’ä¸­ä½†æœªå®ç°**:
  - ã€æœªå®Œæˆã€‘ Kimi K2 API
  - ã€æœªå®Œæˆã€‘ æ™ºè°±GLM-4.5 API
- **åˆ†å·¥å®‰æ’**: é‡‘å»ºå³°è´Ÿè´£æ­¤é¡¹ï¼Œéœ€è¦è¡¥å……kimiå’Œæ™ºè°±GLMçš„å®ç°
- **å»ºè®®**: æ·»åŠ æ™ºè°±GLM-4Vï¼Œå›½å†…è®¿é—®è¾ƒç¨³å®š

### ã€å®Œæˆã€‘ ä»»åŠ¡6: äººå‘˜åˆ†å·¥æ˜ç»†
**çŠ¶æ€**: åˆ†å·¥æ¸…æ™°å®Œæ•´
- **æ–‡ä»¶ä½ç½®**: `äººå‘˜å…·ä½“åˆ†å·¥/äººå‘˜åˆ†å·¥æ˜ç»†.md`
- **å›¢é˜Ÿç»“æ„**:
  - **é‡‘å»ºå³°**: Promptä¼˜åŒ–ã€æ•°æ®å‡†å¤‡ã€å¤šæ¨¡å‹å¯¹æ¯”ã€æŠ¥å‘Šç”Ÿæˆ
  - **æ¨Šæ–‡æ³¢**: æ‰“åˆ†ç³»ç»Ÿå¼€å‘ã€ç¾è§‚æ€§è¯„ä»·ã€æ¨¡å‹è®­ç»ƒç ”ç©¶
  - **å­£äº¢**: åç«¯æ¥å£å¼€å‘ã€æ¨¡å‹è®­ç»ƒç ”ç©¶
- **èŒè´£è¦†ç›–**: å‰ç«¯ã€åç«¯ã€AIæ¨¡å‹ã€æ•°æ®å¤„ç†å…¨æ–¹ä½è¦†ç›–
- **åä½œæ¨¡å¼**: æ¨Šæ–‡æ³¢+å­£äº¢åä½œæ¨¡å‹è®­ç»ƒï¼Œåˆ†å·¥æ˜ç¡®

### ã€å®Œæˆã€‘ ä»»åŠ¡7: å®æ–½æ—¥å¿—ä¸è¿›åº¦æŠ¥å‘Š
**çŠ¶æ€**: å·²å»ºç«‹å®Œå–„çš„è®°å½•ä½“ç³»
- **æ—¥å¿—æ–‡ä»¶**: `æ¯å¤©å®æ–½æ—¥å¿—/` ç›®å½•åŒ…å«è¯¦ç»†è®°å½•
- **æœ€æ–°è¿›å±•** (2025-07-28):
  - æ–°å¢150ä¸ªå°åŒºæ ‡æ³¨ï¼ˆæ€»è®¡300å¼ å›¾ç‰‡ï¼‰
  - ç¾è§‚æ€§è¯„ä»·å·¥å…·å¼€å‘å®Œæˆ
  - åƒé—®APIç ”ç©¶å’Œä»£ç ä¼˜åŒ–
- **æŠ¥å‘Šè´¨é‡**: æœ¬æŠ¥å‘Šæä¾›å…¨é¢çš„ä»»åŠ¡è¯„ä¼°

##  ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### ğŸ“‹ ç±»åˆ«ä¸€ï¼šå®Œæˆæœªå®Œæˆçš„æ ¸å¿ƒä»»åŠ¡

#### 1. **å¤šæ¨¡æ€è¾“å…¥åŠŸèƒ½å¼€å‘**
- **å›¾ç‰‡è¾“å…¥æ”¯æŒ**: å›¾åƒé¢„å¤„ç†ã€base64ç¼–ç ã€å¤šæ¨¡æ€APIè°ƒç”¨
- **åœ°å½¢æ•°æ®æå–**: å»ºç­‘ç‰©ã€é“è·¯ã€æ²³æµçš„çŸ¢é‡åæ ‡
- **æ•°æ®æ ¼å¼æ ‡å‡†åŒ–**: ç»Ÿä¸€ç©ºé—´æ•°æ®çš„è¾“å…¥æ ¼å¼

#### 2. **End-to-Endæ ¸å¿ƒåŠŸèƒ½å¼€å‘** (ä»»åŠ¡4å®Œæˆ)
- **å¼€å‘æ ¸å¿ƒæ²»ç†å¼•æ“**: åˆ›å»ºå®Œæ•´çš„å¤§æ¨¡å‹æ²»ç†å¼•æ“
- **æ„å»ºç»Ÿä¸€Pipelineè„šæœ¬**: æ•´åˆæ²»ç†+æ‰“åˆ†åŠŸèƒ½
- **é›†æˆç¾å­¦è¯„åˆ†å‡½æ•°**: å°†`PPXMGX/utils/beautify_config.py`é›†æˆåˆ°ä¸»æµç¨‹

```python
# ç¤ºä¾‹
import time
import wandb
from pathlib import Path
from beautification import beautification_pipeline
from evaluation import evaluation_pipeline

def call_beautification_function(image_path, image_data, model):
    """ç»Ÿä¸€çš„ç¾åŒ–æ²»ç†APIè°ƒç”¨å‡½æ•°"""
    # è°ƒç”¨æ²»ç†æ¨¡å‹
    treatment_result = beautification_pipeline(image_path, image_data)
    
    # è®¡ç®—ç¾è§‚æ€§è¯„åˆ†
    beauty_score = evaluation_pipeline(treatment_result)
    
    return {
        'input_data': image_data,
        'output_data': treatment_result['output_data'],
        'beauty_score': beauty_score,
        'input_tokens': treatment_result['input_tokens'],
        'output_tokens': treatment_result['output_tokens'],
    }
```

#### 2. ** å¤šæ¨¡å‹APIå®Œå–„** (ä»»åŠ¡5å®Œæˆ)
- **å®ç°Kimi K2 APIæ¥å£**
- **å®ç°æ™ºè°±GLM-4.5 APIæ¥å£**
- **ç»Ÿä¸€æ¨¡å‹è°ƒç”¨æ¥å£**

```python
# ç¤ºä¾‹: unified_model_api.py
class ModelManager:
    def __init__(self):
        self.apis = {
            'openai': self._init_openai(),
            'qwen': self._init_qwen(),
            'kimi': self._init_kimi(),      # æ–°å¢
            'glm': self._init_glm()         # æ–°å¢
        }
    
    def _init_kimi(self):
        # Kimi K2 API é…ç½®
        return KimiAPI(
            api_key=os.getenv('KIMI_API_KEY'),
            model_name='kimi-k2'
        )
    
    def _init_glm(self):
        # æ™ºè°±GLM API é…ç½®
        return GLMAPI(
            api_key=os.getenv('GLM_API_KEY'),
            model_name='glm-4v-plus'
        )

    ...
```

###  ç±»åˆ«äºŒï¼šåŸºäºå½“å‰è¿›åº¦çš„æ‰©å±•ä»»åŠ¡

#### 1. ** æ‰¹é‡å›¾åƒå¤„ç†Pipeline**
- **è¿›åº¦è¿½è¸ª**: å®æ—¶æ˜¾ç¤ºå¤„ç†è¿›åº¦
- **ç»“æœæ±‡æ€»**: æ‰¹é‡ç»“æœç»Ÿè®¡å’Œåˆ†æ
- **å¤šå›¾å¹¶è¡Œå¤„ç†**: æ”¯æŒæ‰¹é‡å°åŒºå›¾åƒæ²»ç†


## 1ï¸âƒ£ **WandBè¿½è¸ªé›†æˆ**

```python
# ç®€åŒ–ç‰ˆGISè¿½è¸ªå™¨ - é‡ç‚¹è¿½è¸ªæˆæœ¬å’Œæ•ˆæœ
import wandb
import time

def log_beautification_results(prompt, input_data, output_data, 
                        beauty_score, model_name, image_path,
                        input_tokens, output_tokens):
    """æ ¸å¿ƒåŠŸèƒ½ï¼šè¿½è¸ªæ²»ç†è¿‡ç¨‹çš„å…³é”®æŒ‡æ ‡"""
    
    # å„æ¨¡å‹ä»·æ ¼ï¼ˆæ¯1M tokensï¼‰- è‡ªè¡Œä¿®æ”¹
    pricing = {
        'qwen-vl-max': {'input': 0.1, 'output': 0.3}
    }
    
    cost = (input_tokens * pricing[model_name]['input'] / 1e6 + 
            output_tokens * pricing[model_name]['output'] / 1e6)
    results_dict = {
        # ä¸šåŠ¡æŒ‡æ ‡
        "beauty_score": beauty_score,
        "input_devices": len(input_data),
        "output_devices": len(output_data),
        "improvement": len(output_data) - len(input_data),
        
        # æˆæœ¬æŒ‡æ ‡ï¼ˆé‡è¦ï¼ï¼‰
        "input_tokens": input_tokens,
        "output_tokens": output_tokens,
        "total_cost_usd": cost,
        "cost_per_device": cost / len(input_data) if len(input_data) > 0 else 0,
        
        # æ¨¡å‹ä¿¡æ¯
        "model_name": model_name,
        "prompt_length": len(prompt),
        
        # å¯è§†åŒ–
        "input_image": wandb.Image(image_path) if image_path else None,
    }
    
    # è®°å½•æ‰€æœ‰å…³é”®æ•°æ®
    wandb.log(results_dict)
    return results_dict
    
```

### **æŸ¥çœ‹ç»“æœ**
è®¿é—® https://wandb.ai/ä½ çš„ç”¨æˆ·å/gis-beautification æŸ¥çœ‹è¿½è¸ªç»“æœ

### **Artifactsç”¨é€”**
- ä¿å­˜å®Œæ•´çš„prompt+è¾“å…¥è¾“å‡ºæ•°æ®ï¼Œæ–‡æ¡£ï¼šhttps://docs.wandb.ai/guides/artifacts

## 2ï¸âƒ£ **æ‰¹é‡å¤„ç†é›†æˆ**

```python
# æ‰¹é‡å¤„ç†ç¤ºä¾‹
import multiprocessing as mp
from functools import partial

def process_single_image(task_data):
    """å¤„ç†å•å¼ å›¾åƒçš„å·¥ä½œå‡½æ•°"""
    image_path, image_data, model = task_data
    
    # è°ƒç”¨ç¾åŒ–æ²»ç†API
    start_time = time.perf_counter()
    result = call_beautification_function(image_path, image_data, model)
    process_time = time.perf_counter() - start_time

    input_data = result['input_data']
    output_data = result['output_data'] 
    beauty_score = result['beauty_score']
    
    # è¿”å›ç»“æœæ•°æ®ï¼ˆä¸åœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨wandbï¼‰
    return {
        'image_path': str(image_path),
        'model': model,
        'input_data': input_data,
        'output_data': output_data,
        'beauty_score': beauty_score,
        'process_time': process_time,
        'input_tokens': result.get('input_tokens', 1500),
        'output_tokens': result.get('output_tokens', 800)
    }

def process_batch_with_tracking(input_list, models=['qwen-vl-max'], max_workers=4):
    """æ‰¹é‡å¤„ç†å¤šå¼ å›¾åƒï¼Œä½¿ç”¨multiprocessingå¹¶è¡Œ"""
    
    # åˆå§‹åŒ–WandBï¼ˆä¸»è¿›ç¨‹ï¼‰
    wandb.init(project="gis-beautification", reinit=True)
    
    # å‡†å¤‡ä»»åŠ¡åˆ—è¡¨
    tasks = []
    for image_path, image_data in input_list[:5]:  # é™åˆ¶5å¼ å›¾æµ‹è¯•
        for model in models:
            tasks.append((image_path, image_data, model))
    
    # ä½¿ç”¨è¿›ç¨‹æ± å¹¶è¡Œå¤„ç†
    with mp.Pool(processes=max_workers) as pool:
        results = pool.map(process_single_image, tasks)
    
    # åœ¨ä¸»è¿›ç¨‹ä¸­è®°å½•æ‰€æœ‰ç»“æœåˆ°WandB
    for result in results:
        log_result = log_beautification_results(
            prompt="æ²»ç†è®¾å¤‡ä½ç½®...",
            input_data=result['input_data'],
            output_data=result['output_data'],
            beauty_score=result['beauty_score'],
            model_name=result['model'],
            image_path=result['image_path'],
            input_tokens=result['input_tokens'],
            output_tokens=result['output_tokens']
        )
    
    # è®°å½•æ‰¹é‡å¤„ç†æ±‡æ€»
    wandb.log({
        'batch_images_count': len(set(r['image_path'] for r in results)),
        'batch_avg_beauty_score': sum(r['beauty_score'] for r in results) / len(results)
    })
    
    wandb.finish()
    return results
```